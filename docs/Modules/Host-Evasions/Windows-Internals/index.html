<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Modules/Host-Evasions/Windows-Internals" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.1">
<title data-rh="true">Windows Internals - Windows 内部机制 | TryHackMe CN Mirror</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://tryhackmyoffsecbox.github.io/TryHackMe-CN/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://tryhackmyoffsecbox.github.io/TryHackMe-CN/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://tryhackmyoffsecbox.github.io/TryHackMe-CN/docs/Modules/Host-Evasions/Windows-Internals"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Windows Internals - Windows 内部机制 | TryHackMe CN Mirror"><meta data-rh="true" name="description" content="TryHackMe | Windows Internals"><meta data-rh="true" property="og:description" content="TryHackMe | Windows Internals"><link data-rh="true" rel="icon" href="/TryHackMe-CN/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://tryhackmyoffsecbox.github.io/TryHackMe-CN/docs/Modules/Host-Evasions/Windows-Internals"><link data-rh="true" rel="alternate" href="https://tryhackmyoffsecbox.github.io/TryHackMe-CN/docs/Modules/Host-Evasions/Windows-Internals" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://tryhackmyoffsecbox.github.io/TryHackMe-CN/docs/Modules/Host-Evasions/Windows-Internals" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/TryHackMe-CN/blog/rss.xml" title="TryHackMe CN Mirror RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/TryHackMe-CN/blog/atom.xml" title="TryHackMe CN Mirror Atom Feed"><link rel="stylesheet" href="/TryHackMe-CN/assets/css/styles.351040f8.css">
<script src="/TryHackMe-CN/assets/js/runtime~main.e2ee1920.js" defer="defer"></script>
<script src="/TryHackMe-CN/assets/js/main.e42e1732.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/TryHackMe-CN/"><div class="navbar__logo"><img src="/TryHackMe-CN/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/TryHackMe-CN/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Tryhackme CN Mirror</b></a><a class="navbar__item navbar__link" href="/TryHackMe-CN/docs/LearningPaths/">Learning Paths</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/TryHackMe-CN/docs/Modules/">Modules</a><a class="navbar__item navbar__link" href="/TryHackMe-CN/docs/Networks/">Networks</a><a class="navbar__item navbar__link" href="/TryHackMe-CN/blog">Blog</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/TryHackMe-CN/docs/Modules/">Modules</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/TryHackMe-CN/docs/Modules/Compromising-Active-Directory/">Compromising Active Directory - 妥协活动目录</a><button aria-label="展开侧边栏分类 &#x27;Compromising Active Directory - 妥协活动目录&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/TryHackMe-CN/docs/Modules/Host-Evasions/">Host Evasions - 主机规避</a><button aria-label="折叠侧边栏分类 &#x27;Host Evasions - 主机规避&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/TryHackMe-CN/docs/Modules/Host-Evasions/Abusing-Windows-Internals">Abusing Windows Internals</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/TryHackMe-CN/docs/Modules/Host-Evasions/Introduction-to-Antivirus">Introduction to Antivirus</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/TryHackMe-CN/docs/Modules/Host-Evasions/Introduction-to-Windows-API">Introduction to Windows API - Windows API 简介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/TryHackMe-CN/docs/Modules/Host-Evasions/Windows-Internals">Windows Internals - Windows 内部机制</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/TryHackMe-CN/docs/Modules/Shells-and-Privilege-Escalation/">Shells and Privilege Escalation - Shell 和特权提升</a><button aria-label="展开侧边栏分类 &#x27;Shells and Privilege Escalation - Shell 和特权提升&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/TryHackMe-CN/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/TryHackMe-CN/docs/Modules/Host-Evasions/"><span itemprop="name">Host Evasions - 主机规避</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Windows Internals - Windows 内部机制</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>Windows Internals - Windows 内部机制</h1>
<blockquote>
<p><a href="https://tryhackme.com/room/windowsinternals" target="_blank" rel="noopener noreferrer">TryHackMe | Windows Internals</a></p>
<p>Updated in 2023-12-24</p>
<p>学习并理解 Windows 在其核心运行的基本原理。</p>
<p>Learn and understand the fundamentals of how Windows operates at its core.</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Introduction的直接链接" title="Introduction的直接链接">​</a></h2>
<p>操作系统背后的技术和架构远比我们一开始看到的要 复杂得多。在这个空间里，我们将观察 Windows 操作系统和常见的内部组件。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="学习目标">学习目标<a href="#学习目标" class="hash-link" aria-label="学习目标的直接链接" title="学习目标的直接链接">​</a></h3>
<ul>
<li>理解并与 Windows 进程及其基础技术进行交互。</li>
<li>学习核心文件格式及其用途。</li>
<li>与 Windows 内部交互，了解 Windows 内核的运作方式。</li>
</ul>
<p>由于 Windows 机器构成了大部分企业基础架构，红队需要了解 Windows 内部机制以及如何进行滥用。红队可以在制作攻击性工具或漏洞利用时利用 Windows 进行规避和利用。</p>
<p>在开始这个空间之前，请熟悉基本的 Windows 使用和功能。建议但不强制要求具备 C++ 和 PowerShell 的基本编程知识。</p>
<p>我们提供了一个基础的 Windows 机器，并提供了完成这个空间所需的文件。您可以通过浏览器访问该机器，也可以使用以下凭据通过 RDP 进行访问。</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Machine IP: 10.10.49.92</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Username: THM-Attacker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Password: Tryhackme!</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="processes---进程">Processes - 进程<a href="#processes---进程" class="hash-link" aria-label="Processes - 进程的直接链接" title="Processes - 进程的直接链接">​</a></h2>
<p>一个进程维护和表示程序的执行；一个应用程序可以包含一个或多个进程。进程有许多组件，它们被拆分并存储以便进行交互。微软文档 <a href="https://learn.microsoft.com/en-us/windows/win32/procthread/about-processes-and-threads" target="_blank" rel="noopener noreferrer">About Processes and Threads - Microsoft Learn</a> 将这些其他组件分解为：</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>信息</div><div class="admonitionContent_BuS1"><p>每个进程提供执行程序所需的资源。一个进程具有虚拟地址空间、可执行代码、对系统对象的打开句柄、安全上下文、唯一的进程标识符、环境变量、优先级类、最小和最大工作集大小，以及至少一个执行线程。</p></div></div>
<p>这些信息可能看起来令人望而生畏，但这个空间旨在让这个概念变得稍微简单一些。</p>
<p>如前所述，进程是由应用程序的执行而创建的。进程是 Windows 运行的核心，Windows 的大多数功能都可以被包括在一个应用程序中，并具有相 应的进程。以下是一些启动进程的默认应用程序示例。</p>
<ul>
<li>MsMpEng (Microsoft Defender)</li>
<li>wininit (键盘和鼠标)</li>
<li>lsass (凭据存储)</li>
</ul>
<p>攻击者可以针对进程进行攻击，以规避检测并将恶意软件隐藏为合法进程。以下是攻击者可能针对进程采用的一些潜在攻击向量：</p>
<ul>
<li>进程注入（<a href="https://attack.mitre.org/techniques/T1055/" target="_blank" rel="noopener noreferrer">T1055</a>）</li>
<li>进程空壳化（<a href="https://attack.mitre.org/techniques/T1055/012/" target="_blank" rel="noopener noreferrer">T1055.012</a>）</li>
<li>进程伪装（<a href="https://attack.mitre.org/techniques/T1055/013/" target="_blank" rel="noopener noreferrer">T1055.013</a>）</li>
</ul>
<p>进程具有许多组件；它们可以被分成关键特征，我们可以用这些特征来高层次地描述进程。下表描述了进程的每个关键组件及其用途。</p>
<table><thead><tr><th style="text-align:center">进程组件</th><th style="text-align:center">目的</th></tr></thead><tbody><tr><td style="text-align:center">私有虚拟地址空间</td><td style="text-align:center">进程被分配的虚拟内存地址</td></tr><tr><td style="text-align:center">可执行程序</td><td style="text-align:center">定义存储在虚拟地址空间中的代码和数据</td></tr><tr><td style="text-align:center">打开句柄</td><td style="text-align:center">定义进程可以访问的系统资源句柄</td></tr><tr><td style="text-align:center">安全上下文</td><td style="text-align:center">访问令牌定义了用户、安全组、特权以及其他安全信息</td></tr><tr><td style="text-align:center">进程标识符</td><td style="text-align:center">进程的唯一数字标识符</td></tr><tr><td style="text-align:center">线程</td><td style="text-align:center">进程中被调度执行的部分</td></tr></tbody></table>
<p>我们也可以从更低的层次解释进程，因为它存在于虚拟地址空间中。下面的表格和图表描述了进程在内存中的样子</p>
<table><thead><tr><th style="text-align:center">组件</th><th style="text-align:center">用途</th></tr></thead><tbody><tr><td style="text-align:center">代码</td><td style="text-align:center">进程要执行的代码</td></tr><tr><td style="text-align:center">全局变量</td><td style="text-align:center">存储的变量</td></tr><tr><td style="text-align:center">进程堆</td><td style="text-align:center">定义数据存储的堆</td></tr><tr><td style="text-align:center">进程资源</td><td style="text-align:center">定义进程的其他资源</td></tr><tr><td style="text-align:center">环境块</td><td style="text-align:center">定义进程信息的数据结构</td></tr></tbody></table>
<div style="text-align:center"><p><img loading="lazy" alt="进程在内存中的结构图示" src="/TryHackMe-CN/assets/images/image_20231249-144943-c91e24474e88598be589bb4f00003dec.png" width="661" height="231" class="img_ev3q"></p></div>
<p>这些信息在深入探讨漏洞利用和滥用基础技术时非常有用，但它们仍然非常抽象。我们可以通过在 Windows 任务管理器中观察进程来使其更加具体。任务管理器可以报告有关进程的许多组件和信息。以下是一个简要列出的重要进程详细信息表</p>
<table><thead><tr><th style="text-align:center">数值 / 组件</th><th style="text-align:center">用途</th><th style="text-align:center">示例</th></tr></thead><tbody><tr><td style="text-align:center">名称</td><td style="text-align:center">定义进程的名称，通常从应用程序继承而来</td><td style="text-align:center">conhost.exe</td></tr><tr><td style="text-align:center">PID</td><td style="text-align:center">唯一的数字值，用于识别进程</td><td style="text-align:center">7408</td></tr><tr><td style="text-align:center">状态</td><td style="text-align:center">确定进程的运行状态（运行中、挂起等）</td><td style="text-align:center">运行中</td></tr><tr><td style="text-align:center">用户名</td><td style="text-align:center">启动进程的用户。可以表示进程的权限</td><td style="text-align:center">SYSTEM</td></tr></tbody></table>
<p>作为最终用户，你会与这些东西进行互动，作为攻击者，你会操纵它们。</p>
<p>有多种实用工具可以帮助观察进程，包括 <a href="https://github.com/processhacker/processhacker" target="_blank" rel="noopener noreferrer">Process Hacker 2</a> <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/process-explorer" target="_blank" rel="noopener noreferrer">、Process Explorer</a> 和 <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/procmon" target="_blank" rel="noopener noreferrer">Procmon</a></p>
<p>进程是大多数内部 Windows 组件的核心。以下任务将扩展关于进程及其在 Windows 中的使用的信息。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>“notepad.exe” 的进程 ID 是多少？</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 具体操作步骤 </summary><div><div class="collapsibleContent_i85q"><p>在 <code>Procmon</code> 中，可以增加筛选器，对 <code>notepad</code> 这个字符串进行筛选</p><p><img loading="lazy" alt="筛选 notepad" src="/TryHackMe-CN/assets/images/image_20231206-150609-62c5c745a21cb11b742993cb73cec032.png" width="1494" height="897" class="img_ev3q"></p><p>就可以得到 <code>notepad.exe</code> 的相关信息</p><p><img loading="lazy" alt="筛选 notepad 得到结果" src="/TryHackMe-CN/assets/images/image_20231204-150433-3f86f007389bf060895cba00787fb5f3.png" width="1494" height="897" class="img_ev3q"></p></div></div></details><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">5984</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>前一个进程的父进程 ID 是多少？</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 具体操作步骤 </summary><div><div class="collapsibleContent_i85q"><p>在 <code>notepad.exe</code> 的属性中就可以得到</p><p><img loading="lazy" alt="notepad.exe 属性 properties" src="/TryHackMe-CN/assets/images/image_20231207-150733-901c9e6979ee0b2f39408cc767112913.png" width="1494" height="897" class="img_ev3q"></p></div></div></details><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">3412</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>该进程的完整性级别是多少？</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 具体操作步骤 </summary><div><div class="collapsibleContent_i85q"><p>看上一题的截图就可以得到</p></div></div></details><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">High</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="threads---线程">Threads - 线程<a href="#threads---线程" class="hash-link" aria-label="Threads - 线程的直接链接" title="Threads - 线程的直接链接">​</a></h2>
<p>线程是由进程使用的可执行单元，并根据设备因素进行调度。</p>
<p>设备因素可以根据 CPU 和内存规格、优先级和逻辑因素等而变化。</p>
<p>我们可以简化线程的定义为：“控制进程执行。”</p>
<p>由于线程控制执行，这是一个常被攻击的组件。线程滥用可单独用于辅助代码执行，或更广泛地与其他 API 调用链接，作为其他技术的一部分。</p>
<p>线程与其父进程共享相同的详细信息和资源，例如代码、全局变量等。线程也具有其独特的值和数据，如下表所述。</p>
<table><thead><tr><th style="text-align:center">组件</th><th style="text-align:center">目的</th></tr></thead><tbody><tr><td style="text-align:center">栈</td><td style="text-align:center">所有与线程相关和特定的数据（异常、过程调用等）</td></tr><tr><td style="text-align:center">线程本地存储</td><td style="text-align:center">为分配存储到独特数据环境的指针</td></tr><tr><td style="text-align:center">栈参数</td><td style="text-align:center">分配给每个线程的唯一值</td></tr><tr><td style="text-align:center">上下文结构</td><td style="text-align:center">保存由内核维护的机器寄存器值</td></tr></tbody></table>
<p>线程可能看起来简单朴素，但它们的功能对进程至关重要。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>“notepad.exe” 创建的第一个线程 的线程 ID 是多少？</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 具体操作步骤 </summary><div><div class="collapsibleContent_i85q"><p>筛选 <code>Thread Create</code> 的操作</p><p><img loading="lazy" alt="筛选器 Thread Create" src="/TryHackMe-CN/assets/images/image_20231219-151906-fa2c24c8372404b6653eb9b4fbe5fc21.png" width="1494" height="897" class="img_ev3q"></p><p>第一个创建的线程就是所需要的</p><p><img loading="lazy" alt="筛选器 Thread Create 结果" src="/TryHackMe-CN/assets/images/image_20231220-152038-3becc77d6db71faf3370492fc84efbc2.png" width="1494" height="897" class="img_ev3q"></p></div></div></details><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">5908</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>前一个线程的栈参数是什么？</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 具体操作步骤 </summary><div><div class="collapsibleContent_i85q"><p>查看筛选后的结果，第一个线程就是所需要的</p><p><img loading="lazy" alt="第一个线程 属性" src="/TryHackMe-CN/assets/images/image_20231224-152457-4011afbc379b2eb9e1b2fd85a58240c2.png" width="1494" height="897" class="img_ev3q"></p></div></div></details><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">6584</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="virtual-memory---虚拟内存">Virtual Memory - 虚拟内存<a href="#virtual-memory---虚拟内存" class="hash-link" aria-label="Virtual Memory - 虚拟内存的直接链接" title="Virtual Memory - 虚拟内存的直接链接">​</a></h2>
<p>虚拟内存是 Windows 内部工作及其相互交互的关键组件。虚拟内存允许其他内部组件以类似于物理内存的方式与内存交互，而不会出现应用程序之间的冲突风险。模式和冲突的概念在第 8 个任务中有进一步解释。</p>
<p>虚拟内存为每个进程提供了私有的虚拟地址空间，参考 <a href="https://learn.microsoft.com/en-us/windows/win32/memory/virtual-address-space" target="_blank" rel="noopener noreferrer">Virtual Address Space (Memory Management) - Microsoft Learn</a> 。内存管理器用于将虚拟地址转换为物理地址。通过拥有私有的虚拟地址空间，而不是直接写入物理内存，进程减少了造成损坏的风险。</p>
<p>内存管理器还会使用页面或转移来处理内存。应用程序可能会使用比分配的物理内存更多的虚拟内存；内存管理器会将虚拟内存传输或分页到磁盘以解决这个问题。您可以在下面的图表中看到这个概念。</p>
<div style="text-align:center"><p><img loading="lazy" alt="物理内存与虚拟内存的关系" src="/TryHackMe-CN/assets/images/image_20231206-160643-b1960b0a8d0705a013267159204500e0.png" width="521" height="381" class="img_ev3q"></p></div>
<p>在 32 位 x86 系统上，理论上的最大虚拟地址空间是 4 GB。</p>
<p>这个地址空间被分成两半，低半部分（0x00000000 - 0x7FFFFFFF）分配给进程，如上所述。高半部分（0x80000000 - 0xFFFFFFFF）分配给操作系统内存利用。管理员可以通过设置（increaseUserVA）或使用 AWE（Address Windowing Extensions）来改变这种分配布局，以满足需要更大地址空间的应用程序。</p>
<p>在 64 位现代系统上，理论上的最大虚拟地址空间是 256 TB。</p>
<p>确切的地址布局比例从 32 位系统分配到 64 位系统。</p>
<p>大多数需要设置或使用 AWE <a href="https://learn.microsoft.com/en-us/windows/win32/memory/address-windowing-extensions" target="_blank" rel="noopener noreferrer">Address Windowing Extensions - Microsoft Learn</a> 的问题都可以通过增加理论上的最大值来解决。</p>
<p>您可以在下方的图示中可视化两种地址空间分配布局。</p>
<div style="text-align:center"><p><img loading="lazy" alt="地址空间分配布局 图示" src="data:image/png;base64,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" width="381" height="312" class="img_ev3q"></p></div>
<p>虽然这个概念不直接对应于 Windows 内部或概念，但理解它至关重要。如果正确理解，它可以帮助滥用 Windows 内部。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>32 位 x86 系统的理论最大虚拟地址空间是多少？</p><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">4 GB</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以用哪个默认设置标志来重新分配用户进程的地址空间？</p><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">increaseUserVA</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>“notepad.exe” 的基地址是多少？</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 具体操作步骤 </summary><div><div class="collapsibleContent_i85q"><p>在筛选器中，添加两个条件，对进程名字和操作进行筛选</p><p><img loading="lazy" alt="筛选器 条件" src="/TryHackMe-CN/assets/images/image_20231249-134926-3169ebe334d1ab44da01c8c9022511e8.png" width="1494" height="897" class="img_ev3q"></p><p>对第一条日志，查看具体信息</p><p><img loading="lazy" alt="筛选器筛选后 查看具体信息" src="/TryHackMe-CN/assets/images/image_20231251-135119-ea9c03edece29c6a0fcf9b3164fdadce.png" width="1494" height="897" class="img_ev3q"></p><p>即可得到基地址</p></div></div></details><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0x7ff652ec0000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="dynamic-link-libraries---动态链接库">Dynamic Link Libraries - 动态链接库<a href="#dynamic-link-libraries---动态链接库" class="hash-link" aria-label="Dynamic Link Libraries - 动态链接库的直接链接" title="Dynamic Link Libraries - 动态链接库的直接链接">​</a></h2>
<p>Microsoft 文档 <a href="https://learn.microsoft.com/en-us/troubleshoot/windows-client/deployment/dynamic-link-library#:~:text=A%20DLL%20is%20a%20library,common%20dialog%20box%20related%20functions." target="_blank" rel="noopener noreferrer">What is a DLL - Microsoft Learn</a> 将 DLL 描述为 “一个包含代码和数据的库，可供多个程序同时使用”。</p>
<p>DLL 作为 Windows 应用程序执行背后的核心功能之一。根据 Windows 文档 <a href="https://learn.microsoft.com/en-us/troubleshoot/windows-client/deployment/dynamic-link-library#:~:text=A%20DLL%20is%20a%20library,common%20dialog%20box%20related%20functions." target="_blank" rel="noopener noreferrer">What is a DLL - Microsoft Learn</a> ，“使用 DLL 有助于促进代码的模块化、代码重用、高效的内存使用以及减少磁盘空间。因此，操作系统和程序加载更快，运行更快，并且在计算机上占用更少的磁盘空间。”</p>
<p>当一个 DLL 作为程序中的一个函数被加载时，该 DLL 被指定为依赖项。由于程序依赖于 DLL，攻击者可以针对 DLL 而不是应用程序，来控制执行或功能的某些方面。</p>
<ul>
<li>DLL 劫持（<a href="https://attack.mitre.org/techniques/T1574/001/" target="_blank" rel="noopener noreferrer">T1574.001</a>）</li>
<li>DLL 侧加载（<a href="https://attack.mitre.org/techniques/T1574/002/" target="_blank" rel="noopener noreferrer">T1574.002</a>）</li>
<li>DLL 注入（<a href="https://attack.mitre.org/techniques/T1055/001/" target="_blank" rel="noopener noreferrer">T1055.001</a>）</li>
</ul>
<p>创建 DLL 与任何其他项目 / 应用程序没有太大区别；它们只需要稍微修改语法即可。以下是来自 Visual C++ Win32 Dynamic-Link Library 项目的 DLL 示例。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&quot;stdafx.h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">EXPORTING_DLL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&quot;sampleDLL.h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BOOL APIENTRY </span><span class="token function" style="color:#d73a49">DllMain</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> HANDLE hModule</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> DWORD ul_reason_for_call</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> LPVOID lpReserved</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> TRUE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">HelloWorld</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">MessageBox</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">TEXT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Hello World&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">TEXT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;In a DLL&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> MB_OK</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以下是 DLL 的头文件；它将定义要导入和导出的函数。在任务的下一部分，我们将讨论头文件的重要性（或缺乏重要性）。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">ifndef</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">INDLL_H</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">INDLL_H</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">ifdef</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">EXPORTING_DLL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__declspec</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dllexport</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">HelloWorld</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__declspec</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dllimport</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">HelloWorld</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>DLL 已经创建，但问题在于它们如何在应用程序中使用？</p>
<p>DLL 可以使用加载时动态链接或运行时动态链接加载到程序中。</p>
<p>使用加载时动态链接时，应用程序会对 DLL 函数进行显式调用。只有提供了头文件（.h）和导入库（.lib）文件才能实现这种类型的链接。以下是从应用程序调用导出的 DLL 函数的示例。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&quot;stdafx.h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&quot;sampleDLL.h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> APIENTRY </span><span class="token function" style="color:#d73a49">WinMain</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HINSTANCE hInstance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> HINSTANCE hPrevInstance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> LPSTR lpCmdLine</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> nCmdShow</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">HelloWorld</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>使用运行时动态链接时，需要使用单独的函数（<code>LoadLibrary</code> 或 <code>LoadLibraryEx</code>）来在运行时加载 DLL。一旦加载，需要使用 <code>GetProcAddress</code> 来识别要调用的导出 DLL 函数。以下是在应用程序中加载和导入 DLL 函数的示例。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">VOID</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">DLLPROC</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">LPTSTR</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HINSTANCE hinstDLL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DLLPROC HelloWorld</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BOOL fFreeDLL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hinstDLL </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">LoadLibrary</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;sampleDLL.dll&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hinstDLL </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HelloWorld </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">DLLPROC</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetProcAddress</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hinstDLL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;HelloWorld&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HelloWorld </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HelloWorld</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fFreeDLL </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">FreeLibrary</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hinstDLL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在恶意代码中，威胁行为者通常会比使用加载时动态链接更多地使用运行时动态链接。这是因为恶意程序可能需要在内存区域之间传输文件，并且传输单个 DLL 比使用其他文件要求更容易管理。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>“notepad.exe” 加载的 “ntdll.dll” 的基址是多少？</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 具体操作步骤 </summary><div><div class="collapsibleContent_i85q"><p>应用以下筛选器规则</p><p><img loading="lazy" alt="筛选器" src="/TryHackMe-CN/assets/images/image_20231201-140105-b04ddc65363c1b569925a140eefa1209.png" width="1494" height="897" class="img_ev3q"></p><p>即可得到具体的日志条目</p></div></div></details><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0x7ffd0be20000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>“notepad.exe” 加载的 “ntdll.dll” 的大小是多少？</p><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0x1ec000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>“notepad.exe” 加载了多少个 DLL？</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 具体操作步骤 </summary><div><div class="collapsibleContent_i85q"><p>筛选 <code>Load Image</code> 的操作，并筛选为加载 <code>.dll</code> 文件的操作</p><p><img loading="lazy" alt="筛选器" src="/TryHackMe-CN/assets/images/image_20231205-140541-91da1cd842a20e8ee560d31e151a6529.png" width="1494" height="897" class="img_ev3q"></p><p>即可得到答案</p></div></div></details><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">51</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="portable-executable-format---可移植可执行文件格式">Portable Executable Format - 可移植可执行文件格式<a href="#portable-executable-format---可移植可执行文件格式" class="hash-link" aria-label="Portable Executable Format - 可移植可执行文件格式的直接链接" title="Portable Executable Format - 可移植可执行文件格式的直接链接">​</a></h2>
<p>可执行文件和应用程序是 Windows 内部操作的重要组成部分。PE（可移植可执行文件）格式定义了关于可执行文件和存储数据的信息。PE 格式还定义了数据组件存储结构的方式。</p>
<p>PE（可移植可执行文件）格式是可执行文件和目标文件的总体结构。PE（可移植可执行文件）和 COFF（通用对象文件格式）文件构成了 PE 格式。</p>
<div style="text-align:center"><p><img loading="lazy" alt="PE 文件 数据结构" src="/TryHackMe-CN/assets/images/image_20231220-142008-cc4c89975faacabbb3e0b0d92973c34c.png" width="423" height="499" class="img_ev3q"></p></div>
<p>PE 数据最常见于可执行文件的十六进制转储。下面我们将分解 calc.exe 的十六进制转储，以了解 PE 数据的各个部分。</p>
<p>PE 数据的结构分为七个组件：</p>
<p>DOS 头部定义文件类型。</p>
<p>MZ DOS 头部将文件格式定义为. exe。下面的十六进制转储部分显示了 DOS 头部。</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Offset(h) 00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000000  4D 5A 90 00 03 00 00 00 04 00 00 00 FF FF 00 00  MZ..........ÿÿ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000010  B8 00 00 00 00 00 00 00 40 00 00 00 00 00 00 00  ¸.......@.......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000020  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000030  00 00 00 00 00 00 00 00 00 00 00 00 E8 00 00 00  ............è...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000040  0E 1F BA 0E 00 B4 09 CD 21 B8 01 4C CD 21 54 68  ..º..´.Í!¸.LÍ!Th</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>DOS Stub 是一个默认在文件开头运行的程序，它打印一个兼容性消息。对于大多数用户来说，这并不影响文件的任何功能。</p>
<p>DOS Stub 打印消息 “This program cannot be run in DOS mode.” DOS Stub 可以在下面的十六进制转储部分看到。</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">00000040  0E 1F BA 0E 00 B4 09 CD 21 B8 01 4C CD 21 54 68  ..º..´.Í!¸.LÍ!Th</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000050  69 73 20 70 72 6F 67 72 61 6D 20 63 61 6E 6E 6F  is program canno</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000060  74 20 62 65 20 72 75 6E 20 69 6E 20 44 4F 53 20  t be run in DOS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000070  6D 6F 64 65 2E 0D 0D 0A 24 00 00 00 00 00 00 00  mode....$.......</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>PE 文件头提供了二进制文件的 PE 头信息。它定义了文件的格式，包含了签名和图像文件头以及其他信息头。</p>
<p>PE 文件头是人类最难理解的部分之一。你可以从下面的十六进制转储部分中 PE 存根的位置开始识别 PE 文件头。</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">000000E0  00 00 00 00 00 00 00 00 50 45 00 00 64 86 06 00  ........PE..d†..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">000000F0  10 C4 40 03 00 00 00 00 00 00 00 00 F0 00 22 00  .Ä@.........ð.&quot;.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000100  0B 02 0E 14 00 0C 00 00 00 62 00 00 00 00 00 00  .........b......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000110  70 18 00 00 00 10 00 00 00 00 00 40 01 00 00 00  p..........@....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000120  00 10 00 00 00 02 00 00 0A 00 00 00 0A 00 00 00  ................</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000130  0A 00 00 00 00 00 00 00 00 B0 00 00 00 04 00 00  .........°......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000140  63 41 01 00 02 00 60 C1 00 00 08 00 00 00 00 00  cA....`Á........</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000150  00 20 00 00 00 00 00 00 00 00 10 00 00 00 00 00  . ..............</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000160  00 10 00 00 00 00 00 00 00 00 00 00 10 00 00 00  ................</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000170  00 00 00 00 00 00 00 00 94 27 00 00 A0 00 00 00  ........”&#x27;.. ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000180  00 50 00 00 10 47 00 00 00 40 00 00 F0 00 00 00  .P...G...@..ð...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000190  00 00 00 00 00 00 00 00 00 A0 00 00 2C 00 00 00  ......... ..,...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">000001A0  20 23 00 00 54 00 00 00 00 00 00 00 00 00 00 00   #..T...........</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">000001B0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">000001C0  10 20 00 00 18 01 00 00 00 00 00 00 00 00 00 00  . ..............</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">000001D0  28 21 00 00 40 01 00 00 00 00 00 00 00 00 00 00  (!..@...........</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">000001E0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>图像可选头部的名称有些误导，但它是 PE 文件头的重要部分。</p>
<p>数据字典是图像可选头部的一部分，它们指向图像数据目录结构。</p>
<p>节表将定义图像中可用的各个节以及其中的信息。如前所述，各个节存储文件的内容，例如代码、导入表和数据。你可以从下面的十六进制转储部分的表格中识别每个节的定义。</p>
<div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">000001F0  2E 74 65 78 74 00 00 00 D0 0B 00 00 00 10 00 00  .text...Ð.......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000200  00 0C 00 00 00 04 00 00 00 00 00 00 00 00 00 00  ................</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000210  00 00 00 00 20 00 00 60 2E 72 64 61 74 61 00 00  .... ..`.rdata..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000220  76 0C 00 00 00 20 00 00 00 0E 00 00 00 10 00 00  v.... ..........</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000230  00 00 00 00 00 00 00 00 00 00 00 00 40 00 00 40  ............@..@</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000240  2E 64 61 74 61 00 00 00 B8 06 00 00 00 30 00 00  .data...¸....0..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000250  00 02 00 00 00 1E 00 00 00 00 00 00 00 00 00 00  ................</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000260  00 00 00 00 40 00 00 C0 2E 70 64 61 74 61 00 00  ....@..À.pdata..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000270  F0 00 00 00 00 40 00 00 00 02 00 00 00 20 00 00  ð....@....... ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000280  00 00 00 00 00 00 00 00 00 00 00 00 40 00 00 40  ............@..@</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000290  2E 72 73 72 63 00 00 00 10 47 00 00 00 50 00 00  .rsrc....G...P..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">000002A0  00 48 00 00 00 22 00 00 00 00 00 00 00 00 00 00  .H...&quot;..........</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">000002B0  00 00 00 00 40 00 00 40 2E 72 65 6C 6F 63 00 00  ....@..@.reloc..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">000002C0  2C 00 00 00 00 A0 00 00 00 02 00 00 00 6A 00 00  ,.... .......j..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">000002D0  00 00 00 00 00 00 00 00 00 00 00 00 40 00 00 42  ............@..B</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>现在头部已经定义了文件的格式和功能，各个节可以定义文件的内容和数据。</p>
<table><thead><tr><th style="text-align:center">Section</th><th style="text-align:center">Purpose</th></tr></thead><tbody><tr><td style="text-align:center">.text</td><td style="text-align:center">包含可执行代码和入口点</td></tr><tr><td style="text-align:center">.data</td><td style="text-align:center">包含已初始化的数据（字符串、变量等）</td></tr><tr><td style="text-align:center">.rdata or .idata</td><td style="text-align:center">包含导入（Windows API）和 DLL</td></tr><tr><td style="text-align:center">.reloc</td><td style="text-align:center">包含重定位信息</td></tr><tr><td style="text-align:center">.rsrc</td><td style="text-align:center">包含应用程序资源（图像等）</td></tr><tr><td style="text-align:center">.debug</td><td style="text-align:center">包含调试信息</td></tr></tbody></table>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>哪个 PE 组件打印了消息 “This program cannot be run in DOS mode”？</p><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">DOS STUB</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>DiE 报告的入口点是什么？</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 具体操作步骤 </summary><div><div class="collapsibleContent_i85q"><p>用 DiE 加载 <code>notepad.exe</code> ，即可看到</p><p><img loading="lazy" alt="DiE notepad.exe" src="/TryHackMe-CN/assets/images/image_20231241-144141-9f93b4f3829d6de7a3fcb8e7c112e658.png" width="1494" height="897" class="img_ev3q"></p></div></div></details><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">000000014001acd0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>“NumberOfSections” 的值是多少？</p><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0006</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>“.data” 节的虚拟地址是多少？</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 具体操作步骤 </summary><div><div class="collapsibleContent_i85q"><p>进入 <code>section</code> 的选项卡，即可看到</p><p><img loading="lazy" alt="DiE section" src="/TryHackMe-CN/assets/images/image_20231243-144333-f91bf9ba841eb464aba7fa522300b1fb.png" width="1494" height="897" class="img_ev3q"></p></div></div></details><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">00024000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>位于偏移量 “0001f99c” 处的字符串是什么？</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 具体操作步骤 </summary><div><div class="collapsibleContent_i85q"><p>进入 <code>Strings</code> 的选项卡，即可看到</p><p><img loading="lazy" alt="DiE Strings" src="/TryHackMe-CN/assets/images/image_20231247-144733-b347414d8220f3cebaf04f9a30b21d79.png" width="1494" height="897" class="img_ev3q"></p></div></div></details><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Microsoft.Notepad</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="interacting-with-windows-internals---与-windows-内部交互">Interacting with Windows Internals - 与 Windows 内部交互<a href="#interacting-with-windows-internals---与-windows-内部交互" class="hash-link" aria-label="Interacting with Windows Internals - 与 Windows 内部交互的直接链接" title="Interacting with Windows Internals - 与 Windows 内部交互的直接链接">​</a></h2>
<p>与 Windows 内部交互可能看起来很复杂，但已经被大大简化。与 Windows 内部交互最可访问和研究的选项是通过 Windows API 调用进行接口交互。Windows API 提供了与 Windows 操作系统交互的原生功能。API 包含 Win32 API 和较少使用的 Win64 API。</p>
<p>在这里，我们只会简要介绍与 Windows 内部相关的几个特定 API 调用的使用。有关 Windows API 的更多信息，请查看 Windows API 的相关资料。</p>
<p>大多数 Windows 内部组件需要与物理硬件和内存交互。</p>
<p>Windows 内核将控制所有程序和进程，并桥接所有软件和硬件交互。这一点特别重要，因为许多 Windows 内部组件在某种形式上需要与内存交互。</p>
<p>默认情况下，应用程序通常无法与内核交互或修改物理硬件，需要一个接口。这个问题通过处理器模式和访问级别来解决。</p>
<p>Windows 处理器有用 户模式和内核模式。处理器将根据访问和请求的模式在这些模式之间进行切换。</p>
<p>用户模式和内核模式之间的切换通常由系统和 API 调用来完成。在文档中，这一点有时被称为 “切换点”。</p>
<table><thead><tr><th style="text-align:center">User mode</th><th style="text-align:center">Kernel Mode</th></tr></thead><tbody><tr><td style="text-align:center">没有直接硬件访问</td><td style="text-align:center">直接硬件访问</td></tr><tr><td style="text-align:center">在私有虚拟地址空间中创建进程</td><td style="text-align:center">在单个共享虚拟地址空间中运行</td></tr><tr><td style="text-align:center">访问 “拥有的内存位置”</td><td style="text-align:center">访问整个物理内存</td></tr></tbody></table>
<p>应用程序在用户模式或 “用户空间” 中启动，直到进行系统调用或通过 API 接口为止。当进行系统调用时，应用程序会切换模式。下图是描述这一过程的流程图。</p>
<div style="text-align:center"><p><img loading="lazy" alt="二进制程序 调用 API 流程图" src="/TryHackMe-CN/assets/images/image_20231213-151316-b2e561514ff658decea6f280e3c4984b.png" width="440" height="449" class="img_ev3q"></p></div>
<p>在查看语言与 Win32 API 的交互方式时，这个过程可能会更加复杂；应用程序在通过 API 之前会经过语言运行时。最常见的例子是 C# 在与 Win32 API 交互并进行系统调用之前通过 CLR 执行。</p>
<p>我们将向本地进程注入一个消息框，以演示通过内存进行交互的概念验证。</p>
<p>编写消息框到内存的步骤如下：</p>
<ol>
<li>为消息框分配本地进程内存。</li>
<li>将消息框写入 / 复制到已分配的内存。</li>
<li>从本地进程内存中执行消息框。</li>
</ol>
<p>在第一步中，我们可以使用 <code>OpenProcess</code> 获取指定进程的句柄。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HANDLE hProcess </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">OpenProcess</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PROCESS_ALL_ACCESS</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Defines access rights</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FALSE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Target handle will not be inhereted</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">DWORD</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">atoi</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Local process supplied by command-line arguments</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在第二步中，我们可以使用 <code>VirtualAllocEx</code> 来分配具有有效载荷缓冲区的内存区域。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">remoteBuffer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">VirtualAllocEx</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hProcess</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Opened target process</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token plain"> payload</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Region size of memory allocation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">MEM_RESERVE </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> MEM_COMMIT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Reserves and commits pages</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PAGE_EXECUTE_READWRITE </span><span class="token comment" style="color:#999988;font-style:italic">// Enables execution and read/write access to the commited pages</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在第三步中，我们可以使用 <code>WriteProcessMemory</code> 将有效载荷写入到已分配的内存区域中。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">WriteProcessMemory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hProcess</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Opened target process</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    remoteBuffer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Allocated memory region</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    payload</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Data to write</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token plain"> payload</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// byte size of data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在第四步中，我们可以使用 <code>CreateRemoteThread</code> 来执行我们在内存中的有效载荷。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">remoteThread </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CreateRemoteThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hProcess</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Opened target process</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Default size of the stack</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">LPTHREAD_START_ROUTINE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">remoteBuffer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Pointer to the starting address of the thread</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Ran immediately after creation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>获取下面可执行文件中的标志</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 具体操作步骤 </summary><div><div class="collapsibleContent_i85q"><p>文件夹内，可以看到程序的源码</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;stdio.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;windows.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> shellcode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;\xd9\xeb\x9b\xd9\x74\x24\xf4\x31\xd2\xb2\x77\x31\xc9\x64\x8b&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;\x71\x30\x8b\x76\x0c\x8b\x76\x1c\x8b\x46\x08\x8b\x7e\x20\x8b&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;\x36\x38\x4f\x18\x75\xf3\x59\x01\xd1\xff\xe1\x60\x8b\x6c\x24&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;\x24\x8b\x45\x3c\x8b\x54\x28\x78\x01\xea\x8b\x4a\x18\x8b\x5a&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;\x20\x01\xeb\xe3\x34\x49\x8b\x34\x8b\x01\xee\x31\xff\x31\xc0&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;\xfc\xac\x84\xc0\x74\x07\xc1\xcf\x0d\x01\xc7\xeb\xf4\x3b\x7c&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;\x24\x28\x75\xe1\x8b\x5a\x24\x01\xeb\x66\x8b\x0c\x4b\x8b\x5a&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;\x1c\x01\xeb\x8b\x04\x8b\x01\xe8\x89\x44\x24\x1c\x61\xc3\xb2&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;\x08\x29\xd4\x89\xe5\x89\xc2\x68\x8e\x4e\x0e\xec\x52\xe8\x9f&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;\xff\xff\xff\x89\x45\x04\xbb\x7e\xd8\xe2\x73\x87\x1c\x24\x52&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;\xe8\x8e\xff\xff\xff\x89\x45\x08\x68\x6c\x6c\x20\x41\x68\x33&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;\x32\x2e\x64\x68\x75\x73\x65\x72\x30\xdb\x88\x5c\x24\x0a\x89&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;\xe6\x56\xff\x55\x04\x89\xc2\x50\xbb\xa8\xa2\x4d\xbc\x87\x1c&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;\x24\x52\xe8\x5f\xff\xff\xff\x68\x6f\x78\x58\x20\x68\x61\x67&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;\x65\x42\x68\x4d\x65\x73\x73\x31\xdb\x88\x5c\x24\x0a\x89\xe3&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;\x68\x32\x7d\x58\x20\x68\x68\x31\x4e\x47\x68\x48\x33\x5f\x37&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;\x68\x6c\x4c\x5f\x37\x68\x63\x37\x5f\x34\x68\x31\x4e\x6a\x33&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;\x68\x54\x48\x4d\x7b\x31\xc9\x88\x4c\x24\x1a\x89\xe1\x31\xd2&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;\x52\x53\x51\x52\xff\xd0\x31\xc0\x50\xff\x55\x08&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;shellcode length: %i&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">strlen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shellcode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LPVOID lpAlloc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">VirtualAlloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4096</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> MEM_COMMIT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PAGE_EXECUTE_READWRITE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">memcpy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lpAlloc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> shellcode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">strlen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shellcode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">lpAlloc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>将 shellcode 提取出来</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    \xd9\xeb\x9b\xd9\x74\x24\xf4\x31\xd2\xb2\x77\x31\xc9\x64\x8b\x71\x30\x8b\x76\x0c\x8b\x76\x1c\x8b\x46\x08\x8b\x7e\x20\x8b\x36\x38\x4f\x18\x75\xf3\x59\x01\xd1\xff\xe1\x60\x8b\x6c\x24\x24\x8b\x45\x3c\x8b\x54\x28\x78\x01\xea\x8b\x4a\x18\x8b\x5a\x20\x01\xeb\xe3\x34\x49\x8b\x34\x8b\x01\xee\x31\xff\x31\xc0\xfc\xac\x84\xc0\x74\x07\xc1\xcf\x0d\x01\xc7\xeb\xf4\x3b\x7c\x24\x28\x75\xe1\x8b\x5a\x24\x01\xeb\x66\x8b\x0c\x4b\x8b\x5a\x1c\x01\xeb\x8b\x04\x8b\x01\xe8\x89\x44\x24\x1c\x61\xc3\xb2\x08\x29\xd4\x89\xe5\x89\xc2\x68\x8e\x4e\x0e\xec\x52\xe8\x9f\xff\xff\xff\x89\x45\x04\xbb\x7e\xd8\xe2\x73\x87\x1c\x24\x52\xe8\x8e\xff\xff\xff\x89\x45\x08\x68\x6c\x6c\x20\x41\x68\x33\x32\x2e\x64\x68\x75\x73\x65\x72\x30\xdb\x88\x5c\x24\x0a\x89\xe6\x56\xff\x55\x04\x89\xc2\x50\xbb\xa8\xa2\x4d\xbc\x87\x1c\x24\x52\xe8\x5f\xff\xff\xff\x68\x6f\x78\x58\x20\x68\x61\x67\x65\x42\x68\x4d\x65\x73\x73\x31\xdb\x88\x5c\x24\x0a\x89\xe3\x68\x32\x7d\x58\x20\x68\x68\x31\x4e\x47\x68\x48\x33\x5f\x37\x68\x6c\x4c\x5f\x37\x68\x63\x37\x5f\x34\x68\x31\x4e\x6a\x33\x68\x54\x48\x4d\x7b\x31\xc9\x88\x4c\x24\x1a\x89\xe1\x31\xd2\x52\x53\x51\x52\xff\xd0\x31\xc0\x50\xff\x55\x08</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>使用 Cutter 进行反汇编</p><div style="text-align:center"><p><img loading="lazy" alt="Cutter 反汇编 shellcode" src="/TryHackMe-CN/assets/images/image_20231222-152200-9fd0c438a5a41cf94debbf0ea553be68.png" width="1160" height="763" class="img_ev3q"></p></div><p>在反编译选项卡中，可以看到 Messagebox 的相关调用</p><p><img loading="lazy" alt="Cutter 反编译 shellcode" src="/TryHackMe-CN/assets/images/image_20231229-152931-6876afe81f0e42e9a4817df32d12f65a.png" width="1160" height="763" class="img_ev3q"></p><p>可以使用 Python 脚本进行解码</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">hex_datas </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;0x7b4d4854&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;0x336a4e31&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;0x345f3763&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;0x375f4c6c&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;0x375f3348&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;0x474e3168&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;0x20587d32&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">res </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> hex_data </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> hex_datas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hex_data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> end</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;--&gt;&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hex_string </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> hex_data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    decoded_text </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">bytes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fromhex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hex_string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">decode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;utf-8&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">decoded_text</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    res </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> decoded_text</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">res</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details><div class="language-plaintext codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plaintext codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">THM{1Nj3c7_4lL_7H3_7h1NG2}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Conclusion的直接链接" title="Conclusion的直接链接">​</a></h2>
<p>Windows 内部机制是 Windows 操作系统运作的核心。这些内部机制若发生变化，就会损害操作系统在基础层面的运作方式。因此，Windows 内部机制成为攻击者值得攻击的目标。</p>
<p>正如房间中多次提到的那样，攻击者可以轻易地滥用 Windows 内部组件的功能来进行恶意行为。欲了解更多信息，请查看《滥用 Windows 内部机制》房间。</p>
<p>这个房间涵盖的许多概念甚至可以转化为 Unix 对应的部分。虽然攻击的具体细节和执行方式可能会有所不同，但很多核心概念保持不变。</p>
<p>总的来说，Windows 内部机制是不可或缺的；红队和蓝队都需要了解其能力，包括使用方法和原因。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/CTF-Archives/Tryhackme-CN/edit/main/docs/Modules/Host-Evasions/Windows-Internals.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/TryHackMe-CN/docs/Modules/Host-Evasions/Introduction-to-Windows-API"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">Introduction to Windows API - Windows API 简介</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/TryHackMe-CN/docs/Modules/Shells-and-Privilege-Escalation/"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">Shells and Privilege Escalation - Shell 和特权提升</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a><ul><li><a href="#学习目标" class="table-of-contents__link toc-highlight">学习目标</a></li></ul></li><li><a href="#processes---进程" class="table-of-contents__link toc-highlight">Processes - 进程</a></li><li><a href="#threads---线程" class="table-of-contents__link toc-highlight">Threads - 线程</a></li><li><a href="#virtual-memory---虚拟内存" class="table-of-contents__link toc-highlight">Virtual Memory - 虚拟内存</a></li><li><a href="#dynamic-link-libraries---动态链接库" class="table-of-contents__link toc-highlight">Dynamic Link Libraries - 动态链接库</a></li><li><a href="#portable-executable-format---可移植可执行文件格式" class="table-of-contents__link toc-highlight">Portable Executable Format - 可移植可执行文件格式</a></li><li><a href="#interacting-with-windows-internals---与-windows-内部交互" class="table-of-contents__link toc-highlight">Interacting with Windows Internals - 与 Windows 内部交互</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Tryhackme CN Mirror Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>